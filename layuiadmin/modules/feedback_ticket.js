/** layui-admin.std-v1.4.0 LPPL License By https://www.layui.com/layuiadmin/ */
 ;"use strict";layui.define(["table","form","op_common"],function(t){function e(){setCacheData("apiLists",l),setCacheData("apiDetails",s)}var i=layui.$,a=(layui.admin,layui.table),n=layui.form,l=layui.api.feedback_get_ticket_lists,s=layui.api.feedback_get_ticket_details,d=layui.api.feedback_update_ticket;n.on("submit(search)",function(t){e(),window.data=t.data,a.reload("lists",{where:t.field,page:{curr:1},done:function(e){initSearchInput(e["extends"],t.field)}})}),i(".op-methods").on("click",function(t){e(),window.data=t.data,window[i(this).data("type")](t.data,a.cache["extends"])}),a.on("tool(lists)",function(t){return e(),window.data=t.data,"set_status"===t.event?void o(t):void(window[t.event]?window[t.event].call(this,t.data,a.cache["extends"]):"")});var o=function(t){var e=t.data;layer.open({content:'<div class="layui-form">\n                        <div class="layui-form-item">\n                            <label class="layui-form-label">请选择</label>\n                            <div class="layui-input-block">\n                                <select name="status">\n                                    <option value="0">待解决</option>\n                                    <option value="'+layui["const"].STATUS_ACCEPTED+'" '+(e.status===layui["const"].STATUS_ACCEPTED?"selected":"")+'>已受理</option>\n                                    <option value="'+layui["const"].STATUS_PROCESSED+'" '+(e.status===layui["const"].STATUS_PROCESSED?"selected":"")+'>待回复</option>\n                                    <option value="'+layui["const"].STATUS_FINISHED+'" '+(e.status===layui["const"].STATUS_FINISHED?"selected":"")+">完成</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>",title:"修改工单【"+e.ticket_sn+"】状态",area:["500px","350px"],success:function(t,e){n.render("select")},yes:function(i,a){var n=parseInt(a.find("select[name=status]").val());return n===e.status?layer.msg("无变更",{icon:7}):(layer.close(i),void ajaxRequestV2(d,"post",{id:e.id,status:n},function(e){0===e.code?(t.update({status:n}),layer.msg(e.msg,{icon:1})):layer.msg(e.msg,{icon:2})}))}})};window.chat_lists=function(t){arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;layer.open({type:2,title:"列表",content:layui.setter.vhtml+"feedback/ticket/chat-list.html?id="+t.id,maxmin:!0,area:["70%","70%"],success:function(e,a){var n=ajaxRequest(layui.api.feedback_get_ticket_details,"get",{id:t.id},!1).responseJSON,l=(e.find("iframe").contents().find("#content"),"");i.each(n.data.lists,function(t,e){var i=0===e.user_id,a=i?e.adminname:e.username,n=i?' align="right" ':"",s=i?" layui-bg-gray ":"",d='<label style="font-size: 5px">&nbsp;&nbsp;&nbsp;&nbsp;时间：'+e.created_at+"</label>";if(l+="<div "+n+'><fieldset class="layui-elem-field '+s+'" style="width: 80%;"><legend>'+a+d+"</legend>",1===e.content_type)l+='<div class="layui-field-box">'+e.contents+"</div></fieldset></div>";else if(2===e.content_type){var o=.3*e.content_meta.width,c=.3*e.content_meta.height;o=o?o:100,c=c?c:100,l+='<div class="layui-field-box layer-photos-demo" id="layer-photos-contents">\n                            <img layer-src="'+e.contents+'" src="'+e.contents+'" style="max-height:145px;max-width: 120px;vertical-align:middle;" alt="contents">\n                            </div></fieldset></div><br/>'}}),e.find("iframe").contents().find("#content").html(l)}})},window.user=function(t){arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;layer.open({type:2,title:"用户",content:layui.setter.vhtml+"user/user/list.html?user_id="+t.data.user_id,maxmin:!0,area:["70%","70%"]})},a.render({elem:"#lists",url:l,headers:{token:layui.data(layui.setter.tableName).user.token},parseData:function(t){return window.parent.listData=t,checkApiStatusByData(t),getListsFormatByData(t)},cols:[[{field:"id",width:90,title:"ID",sort:!0},{field:"app_name",title:"应用名称",minWidth:120,templet:function(t){var e=parent.listData.data["extends"].apps[t.app_id];return void 0!==e?e:"未知"}},{field:"user_id",title:"用户",templet:"#tpl_user_id",align:"center"},{field:"ticket_sn",title:"工单号"},{field:"title",title:"标题"},{field:"is_read",title:"是否已读",templet:"#tpl_is_read",align:"center"},{field:"status",title:"状态",templet:"#tpl_status",align:"center",event:"set_status"},{field:"created_at",title:"创建时间",sort:!0,templet:function(t){return changeUTCTime(t.created_at)}},{field:"updated_at",title:"更新时间",sort:!0,templet:function(t){return changeUTCTime(t.updated_at)}},{title:"操作",width:80,align:"center",fixed:"right",toolbar:"#options"}]],page:!0,limit:20,done:function(t){a.cache["extends"]=t["extends"],initSearchInput(t["extends"])}}),initSearchInput=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};renderSelect("app_id","app_id",t.apps,e.app_id),n.render()},t("feedback_ticket",{}),t("const",{STATUS_WAITING:0,STATUS_ACCEPTED:1,STATUS_PROCESSED:2,STATUS_FINISHED:3})});